"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateZodiacAndSave = void 0;
const express = require('express');
const userHistory_1 = require("../models/userHistory");
const zodiac_1 = require("../models/zodiac");
const login_1 = require("../models/login"); // âœ… à¹€à¸žà¸´à¹ˆà¸¡à¹‚à¸¡à¹€à¸”à¸¥ Account à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
// à¸•à¸²à¸£à¸²à¸‡à¸¥à¸±à¸„à¸™à¸²à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸šà¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸” (à¹à¸šà¹ˆà¸‡à¸Šà¹ˆà¸§à¸‡ 2 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡)
const zodiacTable = {
    "15 à¸¡.à¸„. - 12 à¸.à¸ž.": ["à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹"],
    "13 à¸.à¸ž. - 13 à¸¡à¸µ.à¸„.": ["à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£"],
    "14 à¸¡à¸µ.à¸„. - 12 à¹€à¸¡.à¸¢.": ["à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ"],
    "13 à¹€à¸¡.à¸¢. - 13 à¸ž.à¸„.": ["à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™"],
    "14 à¸ž.à¸„. - 14 à¸¡à¸´.à¸¢.": ["à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©"],
    "15 à¸¡à¸´.à¸¢. - 16 à¸.à¸„.": ["à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ "],
    "17 à¸.à¸„. - 16 à¸ª.à¸„.": ["à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™"],
    "17 à¸ª.à¸„. - 16 à¸.à¸¢.": ["à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž"],
    "17 à¸.à¸¢. - 16 à¸•.à¸„.": ["à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ"],
    "17 à¸•.à¸„. - 15 à¸ž.à¸¢.": ["à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ"],
    "16 à¸ž.à¸¢. - 15 à¸˜.à¸„.": ["à¸žà¸´à¸ˆà¸´à¸", "à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ"],
    "16 à¸˜.à¸„. - 14 à¸¡.à¸„.": ["à¸˜à¸™à¸¹", "à¸¡à¸±à¸‡à¸à¸£", "à¸à¸¸à¸¡à¸ à¹Œ", "à¸¡à¸µà¸™", "à¹€à¸¡à¸©", "à¸žà¸¤à¸©à¸ ", "à¹€à¸¡à¸–à¸¸à¸™", "à¸à¸£à¸à¸Ž", "à¸ªà¸´à¸‡à¸«à¹Œ", "à¸à¸±à¸™à¸¢à¹Œ", "à¸•à¸¸à¸¥à¸¢à¹Œ", "à¸žà¸´à¸ˆà¸´à¸"]
};
const timeSlots = [5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 1, 3];
// âœ… à¹à¸›à¸¥à¸‡à¸Šà¸·à¹ˆà¸­à¸£à¸²à¸¨à¸µà¸ˆà¸²à¸à¹„à¸—à¸¢ -> à¸­à¸±à¸‡à¸à¸¤à¸©
const zodiacMapping = {
    "à¸¡à¸±à¸‡à¸à¸£": "Capricorn", "à¸à¸¸à¸¡à¸ à¹Œ": "Aquarius", "à¸¡à¸µà¸™": "Pisces",
    "à¹€à¸¡à¸©": "Aries", "à¸žà¸¤à¸©à¸ ": "Taurus", "à¹€à¸¡à¸–à¸¸à¸™": "Gemini",
    "à¸à¸£à¸à¸Ž": "Cancer", "à¸ªà¸´à¸‡à¸«à¹Œ": "Leo", "à¸à¸±à¸™à¸¢à¹Œ": "Virgo",
    "à¸•à¸¸à¸¥à¸¢à¹Œ": "Libra", "à¸žà¸´à¸ˆà¸´à¸": "Scorpio", "à¸˜à¸™à¸¹": "Sagittarius"
};
const calculateZodiacAndSave = async (req, res) => {
    try {
        let { userID, birthdate, birthtime } = req.body; // âœ… à¸£à¸±à¸šà¸§à¸±à¸™à¹€à¸à¸´à¸” + à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
        if (!userID) {
            throw new Error("à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸ userID");
        }
        // âœ… à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ˆà¸²à¸ MongoDB
        const user = await login_1.Account.findById(userID).lean();
        if (!user) {
            throw new Error("à¹„à¸¡à¹ˆà¸žà¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸™à¸£à¸°à¸šà¸š");
        }
        // âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ `birthdate` à¸«à¸£à¸·à¸­ `birthtime` à¹ƒà¸«à¹‰à¸”à¸¶à¸‡à¸ˆà¸²à¸ MongoDB
        if (!birthdate)
            birthdate = user.birthday || null;
        // âœ… à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ `birthdate` à¸«à¸£à¸·à¸­ `birthtime` à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¹ƒà¸«à¹‰à¸à¸£à¸­à¸
        if (!birthdate || !birthtime) {
            throw new Error("à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¹€à¸à¸´à¸”à¸‚à¸­à¸‡à¸„à¸¸à¸“ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸§à¸±à¸™à¹€à¸à¸´à¸”à¹à¸¥à¸°à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”");
        }
        console.log("ðŸ“Œ à¸„à¸³à¸™à¸§à¸“à¸¥à¸±à¸„à¸™à¸²à¸£à¸²à¸¨à¸µ:", birthdate, birthtime);
        // âœ… à¹à¸›à¸¥à¸‡à¸£à¸¹à¸›à¹à¸šà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ `DD/MM/YYYY` à¸«à¸£à¸·à¸­ `YYYY-MM-DD`
        let dateParts;
        if (birthdate.includes("-")) {
            dateParts = birthdate.split("-").map(Number); // `YYYY-MM-DD` â†’ `[YYYY, MM, DD]`
        }
        else if (birthdate.includes("/")) {
            dateParts = birthdate.split("/").map(Number); // `DD/MM/YYYY` â†’ `[DD, MM, YYYY]`
        }
        else {
            throw new Error("à¸£à¸¹à¸›à¹à¸šà¸šà¸§à¸±à¸™à¹€à¸à¸´à¸”à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸„à¸§à¸£à¹€à¸›à¹‡à¸™ YYYY-MM-DD à¸«à¸£à¸·à¸­ DD/MM/YYYY");
        }
        const day = birthdate.includes("/") ? dateParts[0] : dateParts[2]; // âœ… à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¸ˆà¸²à¸ `birthdate`
        const monthIndex = birthdate.includes("/") ? dateParts[1] : dateParts[1]; // âœ… à¹ƒà¸Šà¹‰à¹€à¸”à¸·à¸­à¸™à¸•à¸²à¸¡à¸›à¸à¸•à¸´ (1-12)
        // âœ… à¹à¸›à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”à¹€à¸›à¹‡à¸™ `hour`
        const hour = parseInt(birthtime.split(':')[0], 10);
        // âœ… à¹à¸›à¸¥à¸‡à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ (à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™)
        const monthNames = {
            "à¸¡.à¸„.": 1, "à¸.à¸ž.": 2, "à¸¡à¸µ.à¸„.": 3, "à¹€à¸¡.à¸¢.": 4,
            "à¸ž.à¸„.": 5, "à¸¡à¸´.à¸¢.": 6, "à¸.à¸„.": 7, "à¸ª.à¸„.": 8,
            "à¸.à¸¢.": 9, "à¸•.à¸„.": 10, "à¸ž.à¸¢.": 11, "à¸˜.à¸„.": 12
        };
        // âœ… à¸«à¸² `selectedRange`
        let selectedRangeKey = Object.keys(zodiacTable).find(range => {
            const [start, end] = range.split(' - ').map(date => {
                const [d, m] = date.split(' ');
                return { day: parseInt(d, 10), month: monthNames[m] };
            });
            return ((monthIndex > start.month || (monthIndex === start.month && day >= start.day)) &&
                (monthIndex < end.month || (monthIndex === end.month && day <= end.day)));
        });
        if (!selectedRangeKey) {
            return res.status(400).json({ error: "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸”à¸·à¸­à¸™à¹€à¸à¸´à¸”à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡" });
        }
        let selectedRange = zodiacTable[selectedRangeKey];
        // âœ… à¸„à¸³à¸™à¸§à¸“à¸£à¸²à¸¨à¸µà¸•à¸²à¸¡à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²
        let slotIndex = timeSlots.findIndex(slot => hour >= slot && hour < (slot + 2));
        if (slotIndex === -1)
            slotIndex = timeSlots.length - 1;
        let thaiZodiac = selectedRange[slotIndex];
        console.log(`âœ… à¸¥à¸±à¸„à¸™à¸²à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰ (à¹„à¸—à¸¢): ${thaiZodiac}`);
        // âœ… à¹à¸›à¸¥à¸‡à¸£à¸²à¸¨à¸µà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©
        let englishZodiac = zodiacMapping[thaiZodiac] || thaiZodiac;
        console.log(`âœ… à¸¥à¸±à¸„à¸™à¸²à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰ (à¸­à¸±à¸‡à¸à¸¤à¸©): ${englishZodiac}`);
        // âœ… à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¨à¸µà¸ˆà¸²à¸ MongoDB
        const zodiacInfo = await zodiac_1.Zodiac.findOne({ cardNAME: { $regex: `^${englishZodiac}$`, $options: "i" } }).lean();
        if (!zodiacInfo) {
            return res.status(404).json({ error: `à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¨à¸µà¹ƒà¸™ MongoDB: ${englishZodiac}` });
        }
        console.log("âœ… à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¨à¸µà¸—à¸µà¹ˆà¸”à¸¶à¸‡à¸¡à¸²:", zodiacInfo);
        // âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ MongoDB
        const historyEntry = await userHistory_1.UserHistory.create({
            userID,
            type: "zodiac",
            zodiacSign: thaiZodiac,
            birthdate,
            birthtime,
            zodiacImage: zodiacInfo.cardPHOTO,
            zodiacPrediction: zodiacInfo.cardMEANING
        });
        return res.json({
            message: "à¸„à¸³à¸™à¸§à¸“à¸¥à¸±à¸„à¸™à¸²à¸£à¸²à¸¨à¸µà¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¸°à¸šà¸±à¸™à¸—à¸¶à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¹à¸¥à¹‰à¸§",
            userID,
            birthdate,
            birthtime,
            zodiacSign: thaiZodiac,
            englishZodiac,
            zodiacImage: zodiacInfo.cardPHOTO,
            zodiacPrediction: zodiacInfo.cardMEANING,
            historyID: historyEntry._id
        });
    }
    catch (error) {
        console.error("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”:", error.message);
        return res.status(500).json({ error: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ" });
    }
};
exports.calculateZodiacAndSave = calculateZodiacAndSave;
//# sourceMappingURL=zodiac.js.map