const express = require('express');
const router = express.Router();
import { Request, Response } from 'express';
import { UserHistory } from "../models/userHistory";
import { Zodiac } from '../models/zodiac';

// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏±‡∏Ñ‡∏ô‡∏≤‡∏£‡∏≤‡∏®‡∏µ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î (‡πÅ‡∏ö‡πà‡∏á‡∏ä‡πà‡∏ß‡∏á 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
const zodiacTable: Record<string, string[]> = {
    "15 ‡∏°.‡∏Ñ. - 12 ‡∏Å.‡∏û.": ["‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π"],
    "13 ‡∏Å.‡∏û. - 13 ‡∏°‡∏µ.‡∏Ñ.": ["‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£"],
    "14 ‡∏°‡∏µ.‡∏Ñ. - 12 ‡πÄ‡∏°.‡∏¢.": ["‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå"],
    "13 ‡πÄ‡∏°.‡∏¢. - 13 ‡∏û.‡∏Ñ.": ["‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô"],
    "14 ‡∏û.‡∏Ñ. - 14 ‡∏°‡∏¥.‡∏¢.": ["‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©"],
    "15 ‡∏°‡∏¥.‡∏¢. - 16 ‡∏Å.‡∏Ñ.": ["‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†"],
    "17 ‡∏Å.‡∏Ñ. - 16 ‡∏™.‡∏Ñ.": ["‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô"],
    "17 ‡∏™.‡∏Ñ. - 16 ‡∏Å.‡∏¢.": ["‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é"],
    "17 ‡∏Å.‡∏¢. - 16 ‡∏ï.‡∏Ñ.": ["‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå"],
    "17 ‡∏ï.‡∏Ñ. - 15 ‡∏û.‡∏¢.": ["‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå"],
    "16 ‡∏û.‡∏¢. - 15 ‡∏ò.‡∏Ñ.": ["‡∏û‡∏¥‡∏à‡∏¥‡∏Å", "‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå"],
    "16 ‡∏ò.‡∏Ñ. - 14 ‡∏°.‡∏Ñ.": ["‡∏ò‡∏ô‡∏π", "‡∏°‡∏±‡∏á‡∏Å‡∏£", "‡∏Å‡∏∏‡∏°‡∏†‡πå", "‡∏°‡∏µ‡∏ô", "‡πÄ‡∏°‡∏©", "‡∏û‡∏§‡∏©‡∏†", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é", "‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏Å‡∏±‡∏ô‡∏¢‡πå", "‡∏ï‡∏∏‡∏•‡∏¢‡πå", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å"]
};
const timeSlots = [5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 1, 3];
// ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡∏à‡∏≤‡∏Å‡πÑ‡∏ó‡∏¢ -> ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
const zodiacMapping: Record<string, string> = {
    "‡∏°‡∏±‡∏á‡∏Å‡∏£": "Capricorn", "‡∏Å‡∏∏‡∏°‡∏†‡πå": "Aquarius", "‡∏°‡∏µ‡∏ô": "Pisces",
    "‡πÄ‡∏°‡∏©": "Aries", "‡∏û‡∏§‡∏©‡∏†": "Taurus", "‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô": "Gemini",
    "‡∏Å‡∏£‡∏Å‡∏é": "Cancer", "‡∏™‡∏¥‡∏á‡∏´‡πå": "Leo", "‡∏Å‡∏±‡∏ô‡∏¢‡πå": "Virgo",
    "‡∏ï‡∏∏‡∏•‡∏¢‡πå": "Libra", "‡∏û‡∏¥‡∏à‡∏¥‡∏Å": "Scorpio", "‡∏ò‡∏ô‡∏π": "Sagittarius"
};
export const calculateZodiacAndSave = async (req: Request) => {
    try {
        const { userID, birthdate, birthtime } = req.body;
        if (!userID || !birthdate || !birthtime) {
            throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ userID, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î");
        }

        console.log("üìå ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏±‡∏Ñ‡∏ô‡∏≤‡∏£‡∏≤‡∏®‡∏µ:", birthdate, birthtime);
        const date = new Date(birthdate);
        const monthIndex: number = date.getMonth() + 1; // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        const day: number = date.getDate();
        const hour: number = parseInt(birthtime.split(':')[0], 10);

        // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        const monthNames: Record<string, number> = {
            "‡∏°.‡∏Ñ.": 1, "‡∏Å.‡∏û.": 2, "‡∏°‡∏µ.‡∏Ñ.": 3, "‡πÄ‡∏°.‡∏¢.": 4,
            "‡∏û.‡∏Ñ.": 5, "‡∏°‡∏¥.‡∏¢.": 6, "‡∏Å.‡∏Ñ.": 7, "‡∏™.‡∏Ñ.": 8,
            "‡∏Å.‡∏¢.": 9, "‡∏ï.‡∏Ñ.": 10, "‡∏û.‡∏¢.": 11, "‡∏ò.‡∏Ñ.": 12
        };

        // ‚úÖ ‡∏´‡∏≤ `selectedRange`
        let selectedRangeKey = Object.keys(zodiacTable).find(range => {
            const [start, end] = range.split(' - ').map(date => {
                const [d, m] = date.split(' ');
                return { day: parseInt(d, 10), month: monthNames[m] };
            });

            return (
                (monthIndex > start.month || (monthIndex === start.month && day >= start.day)) &&
                (monthIndex < end.month || (monthIndex === end.month && day <= end.day))
            );
        });

        if (!selectedRangeKey) {
            throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }

        let selectedRange = zodiacTable[selectedRangeKey];

        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏®‡∏µ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        let slotIndex = timeSlots.findIndex((slot, index) => {
            let nextSlot = timeSlots[index + 1] || timeSlots[0];
            return hour >= slot && hour < nextSlot;
        });

        if (slotIndex === -1) slotIndex = 0;

        let thaiZodiac = selectedRange[slotIndex];
        console.log(`‚úÖ ‡∏•‡∏±‡∏Ñ‡∏ô‡∏≤‡∏£‡∏≤‡∏®‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÑ‡∏ó‡∏¢): ${thaiZodiac}`);

        // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
        let englishZodiac = zodiacMapping[thaiZodiac] || thaiZodiac;
        console.log(`‚úÖ ‡∏•‡∏±‡∏Ñ‡∏ô‡∏≤‡∏£‡∏≤‡∏®‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©): ${englishZodiac}`);

        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á MongoDB
        const historyEntry = await UserHistory.create({
            userID,
            type: "zodiac",
            zodiacSign: thaiZodiac,
            birthdate,
            birthtime
        });

        // ‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡∏à‡∏≤‡∏Å MongoDB
        const zodiacInfo = await Zodiac.findOne({ cardNAME: { $regex: `^${englishZodiac}$`, $options: "i" } }).lean();
        if (!zodiacInfo) {
            throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô MongoDB: ${englishZodiac}`);
        }

        console.log("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤:", zodiacInfo);

        return {
            userID,
            birthdate,
            birthtime,
            zodiacSign: thaiZodiac,
            englishZodiac,
            historyID: historyEntry._id,
            zodiacData: zodiacInfo
        };

    } catch (error: any) {
        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error.message);
        throw new Error(error.message);
    }
};